<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Pagamenti - Rari Nantes Trento</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <header>
    <div class="header-container">
      <img src="../assets/images/logo.png" alt="Logo Rari Nantes Trento" class="logo" />
      <button class="logout-btn" onclick="location.href='../index.html'">Logout</button>
    </div>
  </header>

  <nav>
    <div class="nav-container">
      <a href="inserimento-dati-tesserati.html" >Anagrafica</a>
      <a href="inserimento-dati-corsi.html">Corsi</a>
      <a href="pagamenti.html"   class="active">Pagamenti</a>
      <a href="ricerca-dati.html">Ricerca</a>
    </div>
  </nav>

    <main>
        <div class="form-container">
            <h2 class="form-title">Registrazione Pagamenti</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="tesserato" class="required-field">Seleziona Tesserato</label>
                    <select id="tesserato" name="tesserato" required onchange="caricaCorsiTesserato()">
                        <option value="">-- Seleziona --</option>
                        <!-- Opzioni verranno caricate dinamicamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="corso" class="required-field">Seleziona Corso</label>
                    <select id="corso" name="corso" required disabled>
                        <option value="">-- Seleziona prima un tesserato --</option>
                    </select>
                </div>
            </div>
            
            <div id="infoTesserato" class="info-utente" style="display: none;">
                <h3>Informazioni Tesserato</h3>
                <p><strong>Nome:</strong> <span id="infoNome"></span></p>
                <p><strong>Cognome:</strong> <span id="infoCognome"></span></p>
                <p><strong>Corso:</strong> <span id="infoCorso"></span></p>
                <p><strong>Lezioni totali:</strong> <span id="infoLezioniTotali"></span></p>
                <p><strong>Lezioni pagate:</strong> <span id="infoLezioniPagate"></span></p>
                <p><strong>Lezioni rimanenti:</strong> <span id="infoLezioniRimanenti"></span></p>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="num_lezioni" class="required-field">Numero Lezioni da Pagare</label>
                    <input type="number" id="num_lezioni" name="num_lezioni" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="importo" class="required-field">Importo (€)</label>
                    <input type="number" id="importo" name="importo" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="data_pagamento" class="required-field">Data Pagamento</label>
                    <input type="date" id="data_pagamento" name="data_pagamento" required>
                </div>
                
                <div class="form-group">
                    <label for="metodo_pagamento" class="required-field">Metodo di Pagamento</label>
                    <select id="metodo_pagamento" name="metodo_pagamento" required>
                        <option value="">-- Seleziona --</option>
                        <option value="contanti">Contanti</option>
                        <option value="carta">Carta di Credito</option>
                        <option value="bonifico">Bonifico Bancario</option>
                        <option value="satispay">Satispay</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label for="note_pagamento">Note Pagamento</label>
                    <textarea id="note_pagamento" name="note_pagamento" rows="2"></textarea>
                </div>
            </div>
            <div id="feedback" class="feedback-msg" style="display: none;"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="registraPagamento()">Registra Pagamento</button>
                <button type="reset" class="btn btn-secondary">Azzera Campi</button>
            </div>
            
            <div class="table-container">
                <h3 class="table-title">Storico Pagamenti</h3>
                <div id="storicoPagamentiContainer">
                    <p class="nessun-risultato">Seleziona un tesserato e un corso per visualizzare lo storico pagamenti</p>
                </div>
            </div>
            
            <div class="table-container">
                <h3 class="table-title">Calendario Lezioni</h3>
                <div id="calendarioLezioniContainer">
                    <p class="nessun-risultato">Seleziona un tesserato e un corso per visualizzare il calendario lezioni</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
    <div class="footer-container">
      <p>&copy; 2023 Rari Nantes Trento. Tutti i diritti riservati.</p>
    </div>
  </footer>

    <script>
    // Date stagione
    const dataInizioStagione = new Date('2023-09-01');
    const dataFineStagione = new Date('2024-06-30');
    
    function logout() {
        sessionStorage.removeItem('secretaryAuth');
        window.location.href = 'C:/Users/Elia/Lavoro/Piscina/Programma/tesserati/pages/login.html';
    }
    
    // Carica i tesserati al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
        caricaTesserati();
        // Imposta la data di oggi come default
        document.getElementById('data_pagamento').valueAsDate = new Date();
    });
    
    // Carica i tesserati dal localStorage
    function caricaTesserati() {
        const select = document.getElementById('tesserato');
        const tesserati = JSON.parse(localStorage.getItem('tesserati') || '[]');
        
        select.innerHTML = '<option value="">-- Seleziona --</option>';
        
        tesserati.forEach(t => {
            if (t && t.cognome && t.nome) {
                const option = document.createElement('option');
                option.value = t.codice_fiscale || `${t.nome}${t.cognome}`;
                option.textContent = `${t.cognome} ${t.nome} (${t.codice_fiscale || 'N/D'})`;
                select.appendChild(option);
            }
        });
    }
    
    // Carica i corsi del tesserato selezionato
    function caricaCorsiTesserato() {
        const tesseratoId = document.getElementById('tesserato').value;
        const selectCorsi = document.getElementById('corso');
        
        selectCorsi.innerHTML = '<option value="">-- Seleziona --</option>';
        selectCorsi.disabled = true;
        document.getElementById('infoTesserato').style.display = 'none';
        
        if (!tesseratoId) return;

        const corsi = JSON.parse(localStorage.getItem('corsi') || []);
        const tesserati = JSON.parse(localStorage.getItem('tesserati') || []);
        
        // Trova il tesserato selezionato
        const tesserato = tesserati.find(t => 
            (t.codice_fiscale || `${t.nome}${t.cognome}`) === tesseratoId
        );
        
        if (!tesserato) return;

        // Filtra i corsi del tesserato
        const corsiTesserato = corsi.filter(c => 
            c.tesserato === tesseratoId || 
            c.tesserato === tesserato.codice_fiscale
        );
        
        if (corsiTesserato.length === 0) {
            selectCorsi.innerHTML = '<option value="">Nessun corso trovato</option>';
            return;
        }
        
        // Popola la select dei corsi
        corsiTesserato.forEach((corso, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.dataset.corso = JSON.stringify(corso);
            option.textContent = `${getCorsoName(corso.tipo)} - ${corso.livello}`;
            selectCorsi.appendChild(option);
        });
        
        selectCorsi.disabled = false;
        selectCorsi.onchange = caricaInfoCorso;
    }
    
    // Carica le informazioni del corso selezionato
    function caricaInfoCorso() {
        const tesseratoId = document.getElementById('tesserato').value;
        const corsoIndex = document.getElementById('corso').value;
        
        if (!tesseratoId || corsoIndex === "") {
            document.getElementById('infoTesserato').style.display = 'none';
            return;
        }
        
        const selectCorsi = document.getElementById('corso');
        const corsoOption = selectCorsi.options[selectCorsi.selectedIndex];
        const corso = JSON.parse(corsoOption.dataset.corso);
        
        const tesserati = JSON.parse(localStorage.getItem('tesserati') || []);
        const tesserato = tesserati.find(t => 
            (t.codice_fiscale || `${t.nome}${t.cognome}`) === tesseratoId
        );
        
        if (!corso || !tesserato) return;

        // Calcola lezioni pagate
        const pagamenti = JSON.parse(localStorage.getItem('pagamenti') || []);
        const pagamentiCorso = pagamenti.filter(p => 
            (p.tesseratoId === tesseratoId || p.tesseratoId === tesserato.codice_fiscale) &&
            JSON.stringify(corso) === JSON.stringify(JSON.parse(p.corsoData || '{}'))
        );
        
        const lezioniPagate = pagamentiCorso.reduce((sum, p) => sum + parseInt(p.num_lezioni), 0);
        
        // Aggiorna UI
        document.getElementById('infoNome').textContent = tesserato.nome || 'N/D';
        document.getElementById('infoCognome').textContent = tesserato.cognome || 'N/D';
        document.getElementById('infoCorso').textContent = `${getCorsoName(corso.tipo)} - ${corso.livello}`;
        document.getElementById('infoLezioniTotali').textContent = corso.num_lezioni || 'N/D';
        document.getElementById('infoLezioniPagate').textContent = lezioniPagate;
        document.getElementById('infoLezioniRimanenti').textContent = (corso.num_lezioni - lezioniPagate) || 'N/D';
        
        document.getElementById('infoTesserato').style.display = 'block';
        
        // Aggiorna storico e calendario
        caricaStoricoPagamenti(tesseratoId, corso);
        caricaCalendarioLezioni(corso);
    }
    
    // Carica lo storico pagamenti
    function caricaStoricoPagamenti(tesseratoId, corso) {
        const container = document.getElementById('storicoPagamentiContainer');
        const pagamenti = JSON.parse(localStorage.getItem('pagamenti') || []);
        const pagamentiFiltrati = pagamenti.filter(p => 
            (p.tesseratoId === tesseratoId) &&
            JSON.stringify(corso) === JSON.stringify(JSON.parse(p.corsoData || '{}'))
        );
        
        if (pagamentiFiltrati.length === 0) {
            container.innerHTML = '<p class="nessun-risultato">Nessun pagamento registrato per questo corso</p>';
            return;
        }
        
        let html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data Pagamento</th>
                        <th>Lezioni Pagate</th>
                        <th>Importo</th>
                        <th>Metodo</th>
                        <th>Operatore</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>`;
        
        pagamentiFiltrati.forEach(pagamento => {
            html += `
                <tr>
                    <td>${new Date(pagamento.data_pagamento).toLocaleDateString('it-IT')}</td>
                    <td>${pagamento.num_lezioni}</td>
                    <td>${parseFloat(pagamento.importo).toFixed(2)} €</td>
                    <td>${pagamento.metodo_pagamento}</td>
                    <td>${pagamento.operatore}</td>
                    <td>${pagamento.note_pagamento || ''}</td>
                </tr>`;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
    
    // Carica il calendario lezioni
    function caricaCalendarioLezioni(corso) {
        const container = document.getElementById('calendarioLezioniContainer');
        
        if (!corso.dateLezioni || corso.dateLezioni.length === 0) {
            container.innerHTML = '<p class="nessun-risultato">Nessuna lezione programmata per questo corso</p>';
            return;
        }
        
        // Calcola lezioni pagate
        const pagamenti = JSON.parse(localStorage.getItem('pagamenti') || []);
        const pagamentiCorso = pagamenti.filter(p => 
            JSON.stringify(corso) === JSON.stringify(JSON.parse(p.corsoData || '{}'))
        );
        const lezioniPagate = pagamentiCorso.reduce((sum, p) => sum + parseInt(p.num_lezioni), 0);
        
        let html = `
            <div class="info-utente">
                <strong>Lezioni totali:</strong> ${corso.num_lezioni} 
                <strong> | Lezioni pagate:</strong> ${lezioniPagate}
                <strong> | Lezioni rimanenti:</strong> ${corso.num_lezioni - lezioniPagate}
            </div>
            <div class="lista-lezioni">`;
        
        corso.dateLezioni.forEach((data, index) => {
            const isPagata = index < lezioniPagate;
            html += `
                <div class="lezione-item ${isPagata ? 'lezione-pagata' : 'lezione-da-pagare'}">
                    ${new Date(data).toLocaleDateString('it-IT')}
                    <span class="badge ${isPagata ? 'badge-green' : 'badge-red'}">
                        ${isPagata ? 'Pagata' : 'Da pagare'}
                    </span>
                </div>`;
        });
        
        html += `</div>`;
        container.innerHTML = html;
    }
    
    // Registra un nuovo pagamento
    function registraPagamento() {
        // 1. Recupera i valori dal form
        const tesseratoId = document.getElementById('tesserato').value;
        const corsoIndex = document.getElementById('corso').value;
        const numLezioniInput = document.getElementById('num_lezioni').value;
        const importoInput = document.getElementById('importo').value;
        const dataPagamento = document.getElementById('data_pagamento').value;
        const metodoPagamento = document.getElementById('metodo_pagamento').value;
        const note = document.getElementById('note_pagamento').value.trim();
        const feedbackEl = document.getElementById('feedback');

        // 2. Validazione di base
        if (!tesseratoId || corsoIndex === "" || !numLezioniInput || !importoInput || !dataPagamento || !metodoPagamento) {
            showFeedback('Compila tutti i campi obbligatori', 'error');
            return;
        }

        const numLezioni = parseInt(numLezioniInput);
        const importo = parseFloat(importoInput);

        if (isNaN(numLezioni) || numLezioni <= 0) {
            showFeedback('Inserisci un numero valido di lezioni', 'error');
            return;
        }

        if (isNaN(importo) || importo <= 0) {
            showFeedback('Inserisci un importo valido', 'error');
            return;
        }

        // 3. Recupera i dati del corso
        const selectCorsi = document.getElementById('corso');
        const corsoOption = selectCorsi.options[selectCorsi.selectedIndex];
        const corso = JSON.parse(corsoOption.dataset.corso);

        if (!corso) {
            showFeedback('Corso non trovato', 'error');
            return;
        }

        // 4. Calcola lezioni già pagate
        const pagamenti = JSON.parse(localStorage.getItem('pagamenti') || []);
        const pagamentiCorso = pagamenti.filter(p => 
            p.tesseratoId === tesseratoId && 
            JSON.stringify(corso) === JSON.stringify(JSON.parse(p.corsoData || '{}'))
        );

        const lezioniPagate = pagamentiCorso.reduce((sum, p) => sum + parseInt(p.num_lezioni), 0);
        const lezioniRimanenti = corso.num_lezioni - lezioniPagate;

        // 5. Controlla se supera il limite
        if (numLezioni > lezioniRimanenti) {
            showFeedback(`Non puoi pagare più di ${lezioniRimanenti} lezioni rimanenti`, 'error');
            return;
        }

        // 6. Crea l'oggetto pagamento
        const nuovoPagamento = {
            id: generateId(),
            tesseratoId: tesseratoId,
            corsoData: JSON.stringify(corso),
            num_lezioni: numLezioni,
            importo: importo.toFixed(2),
            data_pagamento: dataPagamento,
            metodo_pagamento: metodoPagamento,
            note_pagamento: note,
            operatore: getOperatore(),
            data_registrazione: new Date().toISOString()
        };

        // 7. Salva nel localStorage
        try {
            pagamenti.push(nuovoPagamento);
            localStorage.setItem('pagamenti', JSON.stringify(pagamenti));

            // 8. Feedback e reset
            showFeedback('Pagamento registrato con successo!', 'success');
            
            // Resetta solo i campi del pagamento
            document.getElementById('num_lezioni').value = '';
            document.getElementById('importo').value = '';
            document.getElementById('data_pagamento').valueAsDate = new Date();
            document.getElementById('metodo_pagamento').value = '';
            document.getElementById('note_pagamento').value = '';

            // 9. Aggiorna la visualizzazione
            caricaInfoCorso();
            
        } catch (error) {
            console.error('Errore nel salvataggio:', error);
            showFeedback('Errore durante il salvataggio del pagamento', 'error');
        }
    }

    // Funzioni di supporto
    function showFeedback(message, type) {
        const feedbackEl = document.getElementById('feedback');
        feedbackEl.textContent = message;
        feedbackEl.className = `feedback-msg ${type}`;
        feedbackEl.style.display = 'block';
        
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, 5000);
    }

    function generateId() {
        return 'pag_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    function getOperatore() {
        // Implementa la logica per recuperare l'utente loggato
        return "Operatore Test";
    }
    
    // Funzione helper per il nome del corso
    function getCorsoName(tipo) {
        const names = {
            'avviamento': 'Avviamento',
            'principianti': 'Principianti',
            'intermedio': 'Intermedio',
            'perfezionamento': 'Perfezionamento',
            'cuffiegb': 'Cuffie Giallo Blu',
            'calottegb': 'Calottine Giallo Blu',
            'propaganda': 'Propaganda',
            'agonisti': 'Agonisti',
            'pallanuoto': 'Pallanuoto'
        };
        return names[tipo] || tipo;
    }
</script>
    <script src="../assets/js/backup.js"></script>
</body>
</html>
