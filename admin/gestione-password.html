<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Password - Rari Nantes Trento</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <header>
    <div class="header-container">
      <img src="../assets/images/logo.png" alt="Rari Nantes Trento Logo" class="logo" />
      <button class="logout-btn" id="logoutButton">Logout</button>
    </div>
  </header>

  <nav>
    <div class="nav-container">
      <a href="javascript:history.back()">Indietro</a>
      <a href="modifica-password.html">Modifica Password</a>
    </div>
  </nav>

  <main>
    <div class="main-container">
      <!-- Profilo Amministratore -->
      <div id="userProfile" class="profile-box"></div>

      <div class="card">
        <div class="login-header">
          <h2>Gestione Password</h2>
          <p>Area riservata all'amministratore</p>
        </div>

        <div class="admin-controls">
          <div class="form-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Cerca per username..." />
          </div>
        </div>

        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Nome</th>
                <th>Ruolo</th>
                <th>Ultimo Accesso</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Inserimento dinamico -->
            </tbody>
          </table>
        </div>

        <div class="alert alert-error hidden" id="errorMessage"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-container">
      <p>&copy; <span id="currentYear">2023</span> Rari Nantes Trento. Tutti i diritti riservati.</p>
    </div>
  </footer>

  <script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();
  </script>

  <script src="../assets/js/auth-system.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const session = AuthSystem.getSession();

      if (!session || session.role !== 'admin') {
        alert("Accesso non autorizzato. Solo gli amministratori possono accedere a questa pagina.");
        window.location.href = '../login.html';
        return;
      }

      AuthSystem.renderProfile();

      document.getElementById('logoutButton').addEventListener('click', () => {
        AuthSystem.logout();
        window.location.href = '../login.html';
      });

      const searchInput = document.getElementById('searchInput');
      const tableBody = document.getElementById('usersTableBody');

      const renderAccounts = (filter = '') => {
        const accounts = AuthSystem.getAllAccounts('AdminMaster!2023');
        tableBody.innerHTML = '';

        Object.entries(accounts).forEach(([username, acc]) => {
          if (filter && !username.includes(filter.toLowerCase())) return;

          const lastLogin = acc.lastLogin ? new Date(acc.lastLogin).toLocaleString('it-IT') : '-';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${username}</td>
            <td>${acc.name}</td>
            <td>${acc.role}</td>
            <td>${lastLogin}</td>
            <td>
              <button class="btn-sm" onclick="alert('Funzione cambio password in sviluppo')">Modifica</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      };

      searchInput.addEventListener('input', () => {
        renderAccounts(searchInput.value.trim());
      });

      renderAccounts();
    });
  </script>
</body>
</html>
