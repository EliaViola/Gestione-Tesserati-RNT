<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Crea Pacchetto Lezioni</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  <main class="form-container">
    <h1 class="form-title">Crea Pacchetto Lezioni</h1>

    <form id="pacchettoForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="nomePacchetto">Nome Pacchetto</label>
          <input type="text" id="nomePacchetto" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="dataInizio">Data Inizio</label>
          <input type="date" id="dataInizio" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="dataFine">Data Fine</label>
          <input type="date" id="dataFine" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="numeroLezioni">Numero di Lezioni</label>
          <input type="number" id="numeroLezioni" class="form-control" min="1" required>
        </div>

        <div class="form-group full-width">
          <label>Giorni della Settimana</label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="1"> Lunedì</label>
            <label><input type="checkbox" value="2"> Martedì</label>
            <label><input type="checkbox" value="3"> Mercoledì</label>
            <label><input type="checkbox" value="4"> Giovedì</label>
            <label><input type="checkbox" value="5"> Venerdì</label>
            <label><input type="checkbox" value="6"> Sabato</label>
            <label><input type="checkbox" value="0"> Domenica</label>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="dateEscluse">Date da Escludere (una per riga)</label>
          <textarea id="dateEscluse" class="form-control" placeholder="Formato: 2025-01-01"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Genera e Salva Pacchetto</button>
      </div>
    </form>

    <div class="anteprima-pacchetto">
      <h3>Anteprima Lezioni Generate</h3>
      <div class="date-lezioni">
        <ul id="anteprimaDate"></ul>
      </div>
    </div>

    <div class="anteprima-pacchetto">
      <h3>Pacchetti Salvati</h3>
      <div id="pacchettiSalvati"></div>
    </div>
  </main>

  <script>
    const form = document.getElementById("pacchettoForm");
    const anteprima = document.getElementById("anteprimaDate");
    const pacchettiSalvati = document.getElementById("pacchettiSalvati");

    function parseDate(str) {
      return new Date(str + "T00:00:00");
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function aggiungiGiorni(data, giorni) {
      const d = new Date(data);
      d.setDate(d.getDate() + giorni);
      return d;
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      anteprima.innerHTML = "";

      const nome = document.getElementById("nomePacchetto").value.trim();
      const dataInizio = parseDate(document.getElementById("dataInizio").value);
      const dataFine = parseDate(document.getElementById("dataFine").value);
      const numeroLezioni = parseInt(document.getElementById("numeroLezioni").value);
      const dateEscluse = document.getElementById("dateEscluse").value
        .split("\n").map(s => s.trim()).filter(s => s);
      const giorniSelezionati = Array.from(document.querySelectorAll('.checkbox-group input:checked'))
        .map(cb => parseInt(cb.value));

      if (!nome || giorniSelezionati.length === 0) {
        alert("Compila tutti i campi richiesti e seleziona almeno un giorno.");
        return;
      }

      const lezioni = [];
      let current = new Date(dataInizio);

      while (lezioni.length < numeroLezioni && current <= dataFine) {
        const giornoSettimana = current.getDay();
        const currentISO = formatDate(current);
        if (giorniSelezionati.includes(giornoSettimana) && !dateEscluse.includes(currentISO)) {
          lezioni.push(currentISO);
        }
        current = aggiungiGiorni(current, 1);
      }

      // Anteprima
      lezioni.forEach(d => {
        const li = document.createElement("li");
        li.textContent = new Date(d).toLocaleDateString("it-IT");
        anteprima.appendChild(li);
      });

      // Salva su backend
      fetch("/api/pacchetti", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, date: lezioni })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        form.reset();
        caricaPacchetti();
      })
      .catch(err => console.error("Errore nel salvataggio:", err));
    });

    function eliminaPacchetto(nome) {
      if (!confirm(`Eliminare il pacchetto "${nome}"?`)) return;
      fetch(`/api/pacchetti/${encodeURIComponent(nome)}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        caricaPacchetti();
      })
      .catch(err => console.error("Errore nella cancellazione:", err));
    }

    function caricaPacchetti() {
      pacchettiSalvati.innerHTML = "";
      fetch("/pacchetti.json")
        .then(res => {
          if (!res.ok) throw new Error("Impossibile leggere pacchetti.");
          return res.json();
        })
        .then(pacchetti => {
          pacchetti.forEach(p => {
            const div = document.createElement("div");
            div.className = "pacchetto-info";
            div.innerHTML = `
              <strong>${p.nome}</strong>
              <button class="btn btn-small btn-elimina" onclick="eliminaPacchetto('${p.nome}')">Elimina</button>
              <ul>${p.date.map(d => `<li>${new Date(d).toLocaleDateString("it-IT")}</li>`).join("")}</ul>
            `;
            pacchettiSalvati.appendChild(div);
          });
        })
        .catch(err => {
          pacchettiSalvati.innerHTML = "<p class='nessun-risultato'>Nessun pacchetto trovato.</p>";
        });
    }

    caricaPacchetti();
  </script>
</body>
</html>
